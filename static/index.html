<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hooker Engineer's Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        body { background-color: #f4f5f7; font-family: 'Segoe UI', sans-serif; }
        .board-container { display: flex; overflow-x: auto; padding: 20px; height: calc(100vh - 120px); }
        .board-column { 
            min-width: 320px; max-width: 320px; background: #ebecf0; 
            border-radius: 5px; margin-right: 15px; display: flex; flex-direction: column; max-height: 100%;
        }
        .column-header { padding: 10px 15px; font-weight: bold; background: #dfe1e6; border-top-left-radius: 5px; border-top-right-radius: 5px; }
        .task-list { padding: 10px; flex-grow: 1; overflow-y: auto; min-height: 100px; }
        .task-card { 
            background: white; padding: 12px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            margin-bottom: 10px; cursor: grab; border-left: 4px solid transparent;
        }
        .task-card:hover { background: #f8f9fa; }
        .task-card.priority-URGENT { border-left-color: #dc3545; }
        .task-card.priority-HIGH { border-left-color: #ffc107; }
        .task-card.priority-NORMAL { border-left-color: #0dcaf0; }
        .badge-tag { margin-right: 3px; font-size: 0.65em; }
        .delete-btn { float: right; cursor: pointer; color: #dc3545; opacity: 0; transition: opacity 0.2s; }
        .task-card:hover .delete-btn { opacity: 1; }
        
        /* Components Table */
        .comp-table-container { padding: 20px; background: white; border-radius: 5px; margin: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark px-3">
        <a class="navbar-brand" href="#">ü™ù Hooker v2.2</a>
        <div class="d-flex align-items-center">
            <ul class="nav nav-pills me-3" id="mainTab" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-pane" type="button">Tasks</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="components-tab" data-bs-toggle="tab" data-bs-target="#components-pane" type="button">Components</button>
                </li>
            </ul>
            <button class="btn btn-outline-light btn-sm" onclick="refresh()">üîÑ Refresh</button>
        </div>
    </nav>

    <div class="tab-content" id="mainTabContent">
        <!-- TASKS PANE -->
        <div class="tab-pane fade show active" id="tasks-pane">
            <div class="d-flex justify-content-end px-4 py-2">
                <button class="btn btn-primary btn-sm" onclick="showTaskModal()">+ New Task</button>
            </div>
            <div class="board-container" id="board"></div>
        </div>

        <!-- COMPONENTS PANE -->
        <div class="tab-pane fade" id="components-pane">
             <div class="comp-table-container">
                <div class="d-flex justify-content-between mb-3">
                    <h4>Inventory</h4>
                    <button class="btn btn-success btn-sm" onclick="showCompModal()">+ Add Component</button>
                </div>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Part #</th>
                            <th>Description</th>
                            <th>Stock</th>
                            <th>Tags</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="compTableBody"></tbody>
                </table>
             </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">New Task</h5><button class="btn-close" onclick="closeModal('addTaskModal')"></button></div>
                <div class="modal-body">
                    <input type="text" id="taskTitle" class="form-control mb-2" placeholder="Title">
                    <textarea id="taskDesc" class="form-control mb-2" placeholder="Description"></textarea>
                    <div class="row mb-2">
                        <div class="col"><select id="taskAssignee" class="form-select"><option>Morty</option><option>Filip</option></select></div>
                        <div class="col"><select id="taskPriority" class="form-select"><option>NORMAL</option><option>HIGH</option><option>URGENT</option></select></div>
                    </div>
                    <input type="text" id="taskTags" class="form-control" placeholder="Tags (comma sep)">
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="createTask()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Add Component Modal -->
    <div class="modal fade" id="addCompModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Add Component</h5><button class="btn-close" onclick="closeModal('addCompModal')"></button></div>
                <div class="modal-body">
                    <input type="text" id="compPart" class="form-control mb-2" placeholder="Part Number (e.g. ESP32-S3)">
                    <input type="text" id="compDesc" class="form-control mb-2" placeholder="Description">
                    <input type="number" id="compStock" class="form-control mb-2" placeholder="Stock Qty" value="0">
                    <input type="text" id="compData" class="form-control mb-2" placeholder="Datasheet URL">
                    <input type="text" id="compTags" class="form-control" placeholder="Tags (comma sep)">
                </div>
                <div class="modal-footer"><button class="btn btn-success" onclick="createComp()">Add to Inventory</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "http://localhost:8000";
        const COLUMNS = ["TODO", "DOING", "BLOCKED", "DONE"];
        let taskModal, compModal;

        document.addEventListener('DOMContentLoaded', () => {
            taskModal = new bootstrap.Modal(document.getElementById('addTaskModal'));
            compModal = new bootstrap.Modal(document.getElementById('addCompModal'));
            refresh();
        });

        function refresh() { fetchTasks(); fetchComponents(); }

        // --- TASKS ---
        async function fetchTasks() {
            try {
                const res = await fetch(`${API_URL}/tasks`);
                const tasks = await res.json();
                renderBoard(tasks);
            } catch (e) { console.error(e); }
        }

        function renderBoard(tasks) {
            const board = document.getElementById("board");
            board.innerHTML = "";
            COLUMNS.forEach(status => {
                const colTasks = tasks.filter(t => t.status === status);
                const col = document.createElement("div");
                col.className = "board-column";
                col.innerHTML = `<div class="column-header d-flex justify-content-between"><span>${status}</span><span class="badge bg-secondary rounded-pill">${colTasks.length}</span></div>`;
                const list = document.createElement("div");
                list.className = "task-list"; list.dataset.status = status;
                
                colTasks.forEach(t => {
                    const card = document.createElement("div");
                    card.className = `task-card priority-${t.priority}`; card.dataset.id = t.id;
                    const tags = t.tags ? t.tags.map(tag => `<span class="badge bg-secondary badge-tag">${tag}</span>`).join('') : '';
                    card.innerHTML = `<div class="d-flex justify-content-between"><strong>${t.title}</strong><span class="delete-btn" onclick="deleteTask(${t.id})">&times;</span></div>
                                      <small class="text-muted">${t.description || ''}</small>
                                      <div class="mt-2 d-flex justify-content-between"><small>üë§ ${t.assignee}</small><div>${tags}</div></div>`;
                    list.appendChild(card);
                });
                col.appendChild(list); board.appendChild(col);
                new Sortable(list, { group: 'shared', animation: 150, onEnd: async (evt) => {
                    if (evt.from !== evt.to) await fetch(`${API_URL}/tasks/${evt.item.dataset.id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({status: evt.to.dataset.status}) });
                    fetchTasks();
                }});
            });
        }

        async function createTask() {
            const body = {
                title: document.getElementById("taskTitle").value,
                description: document.getElementById("taskDesc").value,
                assignee: document.getElementById("taskAssignee").value,
                priority: document.getElementById("taskPriority").value,
                tags: document.getElementById("taskTags").value.split(',').map(t=>t.trim()).filter(t=>t)
            };
            await fetch(`${API_URL}/tasks`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            taskModal.hide(); fetchTasks();
        }

        async function deleteTask(id) { if(confirm("Delete task?")) { await fetch(`${API_URL}/tasks/${id}`, { method: 'DELETE' }); fetchTasks(); }}

        // --- COMPONENTS ---
        async function fetchComponents() {
            try {
                const res = await fetch(`${API_URL}/components`);
                const comps = await res.json();
                const tbody = document.getElementById("compTableBody");
                tbody.innerHTML = "";
                comps.forEach(c => {
                    const tags = c.tags ? c.tags.map(t => `<span class="badge bg-light text-dark border">${t}</span>`).join(' ') : '';
                    tbody.innerHTML += `<tr>
                        <td><strong>${c.part_number}</strong></td>
                        <td>${c.description}</td>
                        <td>${c.stock}</td>
                        <td>${tags}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="deleteComp(${c.id})">&times;</button></td>
                    </tr>`;
                });
            } catch (e) { console.error(e); }
        }

        async function createComp() {
            const body = {
                part_number: document.getElementById("compPart").value,
                description: document.getElementById("compDesc").value,
                stock: parseInt(document.getElementById("compStock").value),
                datasheet_url: document.getElementById("compData").value,
                tags: document.getElementById("compTags").value.split(',').map(t=>t.trim()).filter(t=>t)
            };
            await fetch(`${API_URL}/components`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            compModal.hide(); fetchComponents();
        }

        async function deleteComp(id) { if(confirm("Delete component?")) { await fetch(`${API_URL}/components/${id}`, { method: 'DELETE' }); fetchComponents(); }}

        function showTaskModal() { taskModal.show(); }
        function showCompModal() { compModal.show(); }
        function closeModal(id) { bootstrap.Modal.getInstance(document.getElementById(id)).hide(); }
    </script>
</body>
</html>
